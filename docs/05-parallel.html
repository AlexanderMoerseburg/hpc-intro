<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>HPC Course: Parallelising</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/accessible-code-block-0.0.1/empty-anchor.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>


<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<link rel="stylesheet" href="assets/styles.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.tab('show');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-sm-12 col-md-4 col-lg-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-sm-12 col-md-8 col-lg-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html"><img id="logo" style="height: 25px;" src="assets/img/logo.svg" /></a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="99-setup.html">Setup</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Materials
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="01-intro.html">Introduction to HPC</a>
    </li>
    <li>
      <a href="02-working_on_hpc.html">Working on a HPC cluster</a>
    </li>
    <li>
      <a href="03-slurm.html">Using the SLURM Job Scheduler</a>
    </li>
    <li>
      <a href="04-software.html">Managing Software</a>
    </li>
    <li>
      <a href="05-parallel.html">Parallelising Jobs</a>
    </li>
    <li class="dropdown-header">Cambridge HPC Resources</li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Extras
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="99-cambridge_hpc.html">Cambridge HPC Resources</a>
    </li>
    <li>
      <a href="99-unix_cheatsheet.html">Unix Cheatsheet</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/cambiotraining">GitHub</a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">




</div>


<div class="warning">
<p>These materials are still under development</p>
</div>
<div id="parallelising-jobs" class="section level1">
<h1>Parallelising Jobs</h1>
<div class="highlight">
<h4 id="questions">Questions</h4>
<ul>
<li>How can I parallelise jobs on a HPC?</li>
<li>How can I automate job parallelisation?</li>
</ul>
<h4 id="learning-objectives">Learning Objectives</h4>
<ul>
<li>Distinguish between different kinds of parallel computations: multi-threading within a job and job parallelisation across independent jobs.</li>
<li>Use SLURM <em>job arrays</em> to automatically submit several parallel jobs.</li>
<li>Customise each parallel job of an array to use different input -&gt; output.</li>
</ul>
</div>
<div id="parallelising-tasks" class="section level2">
<h2>Parallelising Tasks</h2>
<p>One of the important concepts in the use of a HPC is <strong>parallelisation</strong>. This concept is used in different ways, and can mean slightly different things.</p>
<p>A program may internally support parallel computation for some of its tasks, which we may refer to as <em>multi-threading</em> or <em>multi-core processing</em>. In this case, there is typically a single set of “input -&gt; output”, so all the parallel computations need to finish in order for us to obtain our result. In other words, there is some dependency between those parallel calculations.</p>
<p>On the other hand, we may want to run the same program on different inputs, where each run is completely independent from the previous run. In these cases we say the task is “embarrassingly parallel”. Usually, running tasks completely in parallel is faster, since we remove the need to keep track of what each task’s status is (since they are independent of each other).</p>
<p>Finally, we may want to do both things: run several jobs in parallel, while each of the jobs does some internal parallelisation of its computations (multi-threading).</p>
<div class="figure">
<img src="images/parallel.svg" alt="" />
<p class="caption">Schematic of parallelisation.</p>
</div>
<div class="note">
<p><strong>Terminology Alert!</strong></p>
<p>Some software packages have an option to specify how many CPU cores to use in their computations (i.e. they can parallelise their calculations). However, in their documentation this you may be referred to as <strong>cores</strong>, <strong>processors</strong>, <strong>CPUs</strong> or <strong>threads</strong>, which are used more or less interchangeably to essentially mean “how many calculations should I run in parallel?”. Although these terms are technically different, when you see this mentioned in the software’s documentation, usually you want to set it as the number of CPU cores you request from the cluster.</p>
</div>
</div>
<div id="job-arrays" class="section level2">
<h2>Job Arrays</h2>
<p>There are several ways to parallelise jobs on a HPC. One of them is to use a built-in functionality in SLURM called <strong>job arrays</strong>.</p>
<p><em>Job arrays</em> are a collection of jobs that run in parallel with identical parameters. Any resources you request (e.g. <code>-c</code>, <code>--mem</code>, <code>-t</code>) apply to each individual job of the “array”. This means that you only need to submit one “master” job, making it easier to manage and automate your analysis using a single script.</p>
<p>Job arrays are created with the <em>SBATCH</em> option <code>-a START-FINISH</code> where <em>START</em> and <em>FINISH</em> are integers defining the range of array numbers created by SLURM. SLURM then creates a special shell variable <code>$SLURM_ARRAY_TASK_ID</code>, which contains the array number for the job being processed. Later in this section we will see how we can use some tricks with this variable to automate our analysis.</p>
<p>For now let’s go through this simple example, which shows what a job array looks like (you can find this script in the course folder <code>slurm_arrays/array_demo.sh</code>):</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="co">#SBATCH -c 2</span></span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="co">#SBATCH -a 1-3</span></span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="co">#SBATCH -o logs/array_demo_%a.log</span></span>
<span id="cb1-5"><a href="#cb1-5"></a></span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="bu">echo</span> <span class="st">&quot;This is job number </span><span class="va">$SLURM_ARRAY_TASK_ID</span><span class="st">&quot;</span></span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="bu">echo</span> <span class="st">&quot;Using </span><span class="va">$SLURM_CPUS_PER_TASK</span><span class="st"> CPUs&quot;</span></span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="bu">echo</span> <span class="st">&quot;Running on </span><span class="va">$(</span><span class="fu">hostname</span><span class="va">)</span><span class="st">&quot;</span></span></code></pre></div>
<p>Submitting this script with <code>sbatch slurm_arrays/array_demo.sh</code> will launch 3 jobs. The “<em>%a</em>” keyword is used in our output filename (<code>-o</code>) and will be replaced by the array number, so that we end up with three files: <code>array_demo_1.log</code>, <code>array_demo_2.log</code> and <code>array_demo_3.log</code>. Looking at the output in those files should make it clearer that <code>$SLURM_ARRAY_TASK_ID</code> stores the array number of each job, and that each of them uses 2 CPUS (<code>-c 2</code> option). The compute node that they run on may be variable (depending on which node was available to run each job).</p>
<div class="note">
<p>You can define job array numbers in multiple ways, not just sequencially.</p>
<details>
<p><summary>More</summary> Here are some examples taken from SLURM’s Job Array Documentation:</p>
<table>
<colgroup>
<col width="22%" />
<col width="77%" />
</colgroup>
<thead>
<tr class="header">
<th align="right">Option</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right"><code>-a 0-31</code></td>
<td align="left">index values between 0 and 31</td>
</tr>
<tr class="even">
<td align="right"><code>-a 1,3,5,7</code></td>
<td align="left">index values of 1, 3, 5 and 7</td>
</tr>
<tr class="odd">
<td align="right"><code>-a 1-7:2</code></td>
<td align="left">index values between 1 and 7 with a step size of 2 (i.e. 1, 3, 5 and 7)</td>
</tr>
</tbody>
</table>
</details>
</div>
<div class="exercise">
<p>Use the <code>pi_estimator.py</code> to obtain a sample of estimates using our method.</p>
</div>
<div id="using-slurm_array_task_id-to-automate-jobs" class="section level3">
<h3>Using <code>$SLURM_ARRAY_TASK_ID</code> to Automate Jobs</h3>
<p>One way to automate our jobs using the job array number (automatically stored in the <code>$SLURM_ARRAY_TASK_ID</code> variable) is to use some command-line tricks.</p>
<p>We will apply these in the following exercises, but here are some “recipes” that can be adapted to different contexts.</p>
<p>Get the N-th file in a directory:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1"></a><span class="fu">ls</span> *_1.fq.gz <span class="kw">|</span> <span class="fu">head</span> -n <span class="va">$SLURM_ARRAY_TASK_ID</span> <span class="kw">|</span> <span class="fu">tail</span> -n 1</span></code></pre></div>
<p>Get the N-th line of a file:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1"></a><span class="fu">head</span> -n <span class="va">$SLURM_ARRAY_TASK_ID</span> config_file.csv <span class="kw">|</span> <span class="fu">tail</span> -n 1</span></code></pre></div>
<p>Example: parse a CSV file</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1"></a><span class="fu">head</span> -n <span class="va">$SLURM_ARRAY_TASK_ID</span> config_file.csv <span class="kw">|</span> <span class="fu">tail</span> -n 1 <span class="kw">|</span> <span class="fu">cut</span> -d <span class="st">&quot;,&quot;</span> -f 1</span></code></pre></div>
<div class="exercise">
<p><strong>TODO: an example using a simulation script</strong></p>
<p><a href="https://youtu.be/alH3yc6tX98" class="uri">https://youtu.be/alH3yc6tX98</a></p>
<p>A PhD student is working on project to understand how coral colonies grow to form the beautiful patterns observed in nature. They are using a mathematical model known as <a href="https://en.wikipedia.org/wiki/Reaction%E2%80%93diffusion_system">Reaction-Diffusion</a>, which models the interaction between two components that can self-activate and mutually inhibit each other.</p>
<p>They have an R script which runs this model and produces an output image as exemplified below. They have been running this script on their laptop, but it takes a while to run and they would like to eventually try many parameter combinations.</p>
</div>
<div class="exercise">
<p><strong>TODO: adjust this exercise to illustrate a bioinformatic-flavoured example.</strong> At this stage of the course could omit the <code>#SBATCH</code> options, or give them as a hidden hint. Also need to build up to this larger example, perhaps by having simpler exercises beforehand.</p>
<ul>
<li>Study and adjust the code and save it in a new script <code>$HOME/rds/hpc-work/hpc_workshop/scripts/03_mapping_array.sh</code></li>
<li>Launch the job with <code>sbatch</code></li>
</ul>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="co">#SBATCH -A &lt;</span><span class="al">FIXME</span><span class="co">&gt;</span></span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="co">#SBATCH -D /home/&lt;</span><span class="al">FIXME</span><span class="co">&gt;/rds/hpc-work/projects/hpc_workshop</span></span>
<span id="cb5-4"><a href="#cb5-4"></a><span class="co">#SBATCH -J mapping_array</span></span>
<span id="cb5-5"><a href="#cb5-5"></a><span class="co">#SBATCH -o scripts/03_mapping_array_%a.log</span></span>
<span id="cb5-6"><a href="#cb5-6"></a><span class="co">#SBATCH -c 2</span></span>
<span id="cb5-7"><a href="#cb5-7"></a><span class="co">#SBATCH -t 00:10:00        # hours:minutes:seconds or days-hours:minutes:seconds</span></span>
<span id="cb5-8"><a href="#cb5-8"></a><span class="co">#SBATCH -p skylake         # or skylake-highmem</span></span>
<span id="cb5-9"><a href="#cb5-9"></a><span class="co">#SBATCH --mem-per-cpu=1G   # max 6G or 12G for skilake-highmem</span></span>
<span id="cb5-10"><a href="#cb5-10"></a><span class="co">#SBATCH -a 1-8             # because we have 8 samples</span></span>
<span id="cb5-11"><a href="#cb5-11"></a></span>
<span id="cb5-12"><a href="#cb5-12"></a><span class="co"># get the file prefix corresponding to the current array job</span></span>
<span id="cb5-13"><a href="#cb5-13"></a><span class="co"># see http://bigdatums.net/2016/02/22/3-ways-to-get-the-nth-line-of-a-file-in-linux/</span></span>
<span id="cb5-14"><a href="#cb5-14"></a><span class="va">PREFIX=$(</span><span class="fu">ls</span> data/*_1.fastq <span class="kw">|</span> <span class="fu">sed</span> <span class="st">&#39;s/_1.fastq//&#39;</span> <span class="kw">|</span> <span class="fu">head</span> -n <span class="va">$SLURM_ARRAY_TASK_ID</span> <span class="kw">|</span> <span class="fu">tail</span> -n 1<span class="va">)</span></span>
<span id="cb5-15"><a href="#cb5-15"></a></span>
<span id="cb5-16"><a href="#cb5-16"></a><span class="co"># get the sample name (without including the data/ path)</span></span>
<span id="cb5-17"><a href="#cb5-17"></a><span class="va">SAMPLE=$(</span><span class="fu">basename</span> <span class="va">$PREFIX)</span></span>
<span id="cb5-18"><a href="#cb5-18"></a></span>
<span id="cb5-19"><a href="#cb5-19"></a><span class="co"># define variables that will be input to our pipeline script</span></span>
<span id="cb5-20"><a href="#cb5-20"></a><span class="va">READ1=</span><span class="st">&quot;data/</span><span class="va">${SAMPLE}</span><span class="st">_1.fastq&quot;</span></span>
<span id="cb5-21"><a href="#cb5-21"></a><span class="va">READ2=</span><span class="st">&quot;data/</span><span class="va">${SAMPLE}</span><span class="st">_2.fastq&quot;</span></span>
<span id="cb5-22"><a href="#cb5-22"></a><span class="va">OUT=</span><span class="st">&quot;alignment_example2/</span><span class="va">${SAMPLE}</span><span class="st">.sam&quot;</span></span>
<span id="cb5-23"><a href="#cb5-23"></a><span class="va">REF=</span><span class="st">&quot;reference/Drosophila_melanogaster.BDGP6.22.dna.toplevel&quot;</span></span>
<span id="cb5-24"><a href="#cb5-24"></a></span>
<span id="cb5-25"><a href="#cb5-25"></a><span class="co"># create output directory</span></span>
<span id="cb5-26"><a href="#cb5-26"></a><span class="fu">mkdir</span> -p <span class="st">&quot;alignment_example2&quot;</span></span>
<span id="cb5-27"><a href="#cb5-27"></a></span>
<span id="cb5-28"><a href="#cb5-28"></a><span class="co"># output some informative messages</span></span>
<span id="cb5-29"><a href="#cb5-29"></a><span class="bu">echo</span> <span class="st">&quot;The input read files are: </span><span class="va">$READ1</span><span class="st"> and </span><span class="va">$READ2</span><span class="st">&quot;</span></span>
<span id="cb5-30"><a href="#cb5-30"></a><span class="bu">echo</span> <span class="st">&quot;The reference genome is: </span><span class="va">$REF</span><span class="st">&quot;</span></span>
<span id="cb5-31"><a href="#cb5-31"></a><span class="bu">echo</span> <span class="st">&quot;Output will go to: </span><span class="va">$OUT</span><span class="st">&quot;</span></span>
<span id="cb5-32"><a href="#cb5-32"></a><span class="bu">echo</span> <span class="st">&quot;Number of CPUs used: </span><span class="va">$SLURM_CPUS_PER_TASK</span><span class="st">&quot;</span></span>
<span id="cb5-33"><a href="#cb5-33"></a></span>
<span id="cb5-34"><a href="#cb5-34"></a><span class="co">#### Run the commands ####</span></span>
<span id="cb5-35"><a href="#cb5-35"></a></span>
<span id="cb5-36"><a href="#cb5-36"></a><span class="co"># Align the reads to the genome</span></span>
<span id="cb5-37"><a href="#cb5-37"></a><span class="ex">bowtie2</span> --very-fast -p <span class="st">&quot;</span><span class="va">$SLURM_CPUS_PER_TASK</span><span class="st">&quot;</span> -x <span class="st">&quot;</span><span class="va">$REF</span><span class="st">&quot;</span> -1 <span class="st">&quot;</span><span class="va">$READ1</span><span class="st">&quot;</span> -2 <span class="st">&quot;</span><span class="va">$READ2</span><span class="st">&quot;</span> <span class="op">&gt;</span> <span class="st">&quot;</span><span class="va">$OUT</span><span class="st">&quot;</span></span></code></pre></div>
</div>
</div>
</div>
<div id="summary" class="section level2">
<h2>Summary</h2>
<div class="highlight">
<h4 id="key-points">Key Points</h4>
<ul>
<li>Some tools internally parallelise some of their computations, which is usually referred to as <em>multi-threading</em> or <em>multi-core processing</em>.</li>
<li>When computational tasks are independent of each other, we can use job parallelisation to make them more efficient.</li>
<li>We can automatically generate parallel jobs using SLURM job arrays with the <code>sbatch</code> option <code>-a</code>.</li>
<li>SLURM creates a variable called <code>$SLURM_ARRAY_TASK_ID</code>, which can be used to customise each individual job of the array.
<ul>
<li>For example we can obtain the input/output information from a simple configuration text file using some command line tools: <code>cat config.csv | head -n $SLURM_ARRAY_TASK_ID | tail -n 1</code></li>
</ul></li>
</ul>
<h4 id="further-resources">Further resources</h4>
<ul>
<li><a href="https://slurm.schedmd.com/job_array.html">SLURM Job Array Documentation</a></li>
</ul>
</div>
</div>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
